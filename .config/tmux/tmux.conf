# Hierarchy:
#  Server
#  ㄴSession
#    ㄴWindow
#      ㄴPane

# Options:
# - Session options (set-option [-g])
# - Window options (set-window-option [-g])

# Keybindings:
# -r means that the bind can repeat without entering prefix again
# -n means that the bind doesn't use the prefix

# -------------------------------------------------------------------
# Session options
# -------------------------------------------------------------------
# Change bind key to ctrl-space
# Default for screen is ctrl-a (ctrl-a is useful in vim)
unbind-key c-b
set-option -g prefix c-space

# Set tmux pane title as terminal window title
set-option -g set-titles on
set-option -g set-titles-string "#{pane_title}"

# Index starts from 1
set-option -g base-index 1
set-option -g pane-base-index 1

# Renumber windows when a window is closed
set-option -g renumber-windows on

# History
set-option -g history-limit 102400

# Repeat time limit (ms)
set-option -g repeat-time 225

# Escape key time limit
set-option -g escape-time 0

# Display messages (ms)
# set-option -g display-time 1000

# 256-color terminal
set-option -g default-terminal "tmux-256color"

# Add truecolor support (tmux info | grep Tc)
set-option -ga terminal-overrides ",xterm-256color:Tc"

# Key binding in the status line (bind-key :)
set-option -g status-keys vi

# Mouse
set-option -g mouse on

# -------------------------------------------------------------------
# Window options
# -------------------------------------------------------------------
# Copy-mode
set-window-option -g mode-keys vi

# -------------------------------------------------------------------
# Key bindings
# -------------------------------------------------------------------
# prefix c-m
bind-key c-m new-window -c "#{pane_current_path}"

# Prefix ctrl-space
bind-key c-space last-window

# Prefix ctrl-n to interactively choose window
bind-key c-n choose-tree -w

# Create tmux new tmux session inside current tmux session
# and switch to the newly created tmux session
bind-key c-i command-prompt -p "new session name:" "new -s '%1' -d -c '~' \; switch-client -t '%1'"

# Split bindings
bind-key | split-window -h
bind-key _ split-window -v
bind-key '\' split-window -h -c "#{pane_current_path}"
bind-key - split-window -v -c "#{pane_current_path}"

# Moving windows
bind-key -r > swap-window -d -t +
bind-key -r < swap-window -d -t -

# Vi keys to navigate panes
bind-key -r C-k select-pane -U
bind-key -r C-j select-pane -D
bind-key -r C-h select-pane -L
bind-key -r C-l select-pane -R

# Vi keys to resize
bind-key -r k resize-pane -U 1
bind-key -r j resize-pane -D 1
bind-key -r h resize-pane -L 1
bind-key -r l resize-pane -R 1

# Vi copy mode
# Ref: https://www.rushiagr.com/blog/2016/06/16/everything-you-need-to-know-about-tmux-copy-pasting-ubuntu/
bind-key -T copy-mode-vi y send-keys -X copy-selection

# Ref: https://unix.stackexchange.com/a/14301/479142
# Move one pane into another pane in different window
# Use `prefix!` to move current pane into its own window
bind-key J command-prompt -p "join pane from:"  "join-pane -s '%%'"

# Kill current session and switch to next or previous session
# Ref: https://unix.stackexchange.com/a/58616
# TODO: simplify this
bind-key X confirm-before -p "Kill #S (y/n)?" "run-shell 'tmux switch-client -p \\\; kill-session -t \"#S\"'"

# Reload ~/.config/tmux.conf
bind-key R source-file ~/.config/tmux/tmux.conf \; display-message "Reloaded!"

# -------------------------------------------------------------------
# Tmux interface
# -------------------------------------------------------------------
# Status
set-option -g status on
set-option -g status-position top
set-option -g status-justify left
set-option -g status-interval 1
set-option -g status-style "fg=brightyellow, bg=black, bold"
# Ref: https://stackoverflow.com/a/15308651
set-option -g status-left "#{?client_prefix,#[reverse][#S]#[noreverse],[#S]} "
set-option -g status-left-length 85
# Ref: https://unix.stackexchange.com/a/277954
# set-option -g status-right "#(uptime | awk '{print $3}' | sed 's/,//')"
set-option -g status-right " #(whoami)"
set-option -g window-status-format "#I:#{=-10:pane_title}"
set-option -g window-status-last-style "fg=black, bg=brightyellow, bold"
set-option -g window-status-current-format "#W#F"
set-option -g window-status-separator "  "
# set-option -g status-right "%H:%M %d-%b-%y"

# Change tmux window title (there's a delay when update window title)
# set-option -g automatic-rename on
# set-option -g automatic-rename-format "#{pane_title}"

# Pane border status to separate the active and inactive pane
set-option -g pane-border-status top
set-option -g pane-active-border-style "fg=brightyellow, bg=black"
set-option -g pane-border-style "fg=black, bg=black"
set-option -g pane-border-format "[#(uptime -p)]"

# Ref: http://www.deanbodenham.com/learn/tmux-pane-colours.html
# set-option -g window-style 'fg=colour252, bg=colour237'
# set-option -g window-active-style 'fg=colour252, bg=black'
